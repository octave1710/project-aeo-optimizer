generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                 String             @id @default(uuid()) @db.Uuid
  email              String             @unique
  name               String?
  createdAt          DateTime           @default(now())
  ownedWorkspaces    Workspace[]        @relation("WorkspaceOwner")
  workspaceMemberships WorkspaceMember[]
}

model Workspace {
  id          String            @id @default(uuid()) @db.Uuid
  name        String
  ownerUserId String            @db.Uuid
  ownerUser   User              @relation("WorkspaceOwner", fields: [ownerUserId], references: [id])
  members     WorkspaceMember[]
  projects    Project[]
}

model WorkspaceMember {
  id          String    @id @default(uuid()) @db.Uuid
  workspaceId String    @db.Uuid
  userId      String    @db.Uuid
  role        String
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@unique([workspaceId, userId])
  @@index([userId])
}

model Project {
  id             String     @id @default(uuid()) @db.Uuid
  workspaceId    String     @db.Uuid
  name           String
  domain         String
  localeCountry  String
  localeLanguage String
  createdAt      DateTime   @default(now())
  workspace      Workspace  @relation(fields: [workspaceId], references: [id])
  querySets      QuerySet[]
  pages          Page[]
  reports        Report[]
  alertRules     AlertRule[]
  alertEvents    AlertEvent[]

  @@index([workspaceId])
}

model QuerySet {
  id        String    @id @default(uuid()) @db.Uuid
  projectId String    @db.Uuid
  name      String
  createdAt DateTime  @default(now())
  project   Project   @relation(fields: [projectId], references: [id])
  queries   Query[]
  serpScans SerpScan[]

  @@index([projectId])
}

model Query {
  id         String    @id @default(uuid()) @db.Uuid
  querySetId String    @db.Uuid
  text       String
  country    String
  device     String
  weight     Float?
  createdAt  DateTime  @default(now())
  querySet   QuerySet  @relation(fields: [querySetId], references: [id])
  serpResults SerpResult[]

  @@index([querySetId])
}

model SerpScan {
  id         String       @id @default(uuid()) @db.Uuid
  querySetId String       @db.Uuid
  startedAt  DateTime
  finishedAt DateTime?
  status     String
  querySet   QuerySet     @relation(fields: [querySetId], references: [id])
  results    SerpResult[]

  @@index([querySetId])
}

model SerpResult {
  id              String   @id @default(uuid()) @db.Uuid
  serpScanId      String   @db.Uuid
  queryId         String   @db.Uuid
  aiAnswerPresent Boolean
  sourcesJson     Json?
  rawJson         Json?
  fetchedAt       DateTime @default(now())
  serpScan        SerpScan @relation(fields: [serpScanId], references: [id])
  query           Query    @relation(fields: [queryId], references: [id])

  @@index([serpScanId])
  @@index([queryId])
}

model Page {
  id            String      @id @default(uuid()) @db.Uuid
  projectId     String      @db.Uuid
  url           String
  discoveredVia String?
  lastFetchedAt DateTime?
  fetchStatus   String?
  httpStatus    Int?
  project       Project     @relation(fields: [projectId], references: [id])
  audits        PageAudit[]

  @@index([projectId])
  @@unique([projectId, url])
}

model PageAudit {
  id                   String   @id @default(uuid()) @db.Uuid
  pageId               String   @db.Uuid
  auditedAt            DateTime
  aeoScore             Int
  rubricVersion        String
  signalsJson          Json?
  recommendationsJson  Json?
  page                 Page     @relation(fields: [pageId], references: [id])

  @@index([pageId])
}

model Report {
  id          String   @id @default(uuid()) @db.Uuid
  projectId   String   @db.Uuid
  periodStart DateTime
  periodEnd   DateTime
  createdAt   DateTime @default(now())
  summaryJson Json?
  project     Project  @relation(fields: [projectId], references: [id])

  @@index([projectId])
}

model AlertRule {
  id            String   @id @default(uuid()) @db.Uuid
  projectId     String   @db.Uuid
  type          String
  thresholdJson Json?
  enabled       Boolean  @default(true)
  project       Project  @relation(fields: [projectId], references: [id])

  @@index([projectId])
}

model AlertEvent {
  id          String   @id @default(uuid()) @db.Uuid
  projectId   String   @db.Uuid
  type        String
  payloadJson Json?
  createdAt   DateTime @default(now())
  project     Project  @relation(fields: [projectId], references: [id])

  @@index([projectId])
}
